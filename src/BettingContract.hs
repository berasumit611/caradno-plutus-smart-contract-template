-- {-# LANGUAGE DataKinds           #-}
-- {-# LANGUAGE NoImplicitPrelude   #-}
-- {-# LANGUAGE TemplateHaskell     #-}
-- {-# LANGUAGE ScopedTypeVariables #-}
-- {-# LANGUAGE OverloadedStrings   #-}
-- {-# LANGUAGE DeriveAnyClass      #-}
-- {-# LANGUAGE DeriveGeneric       #-}
-- {-# LANGUAGE MultiParamTypeClasses #-}
-- {-# LANGUAGE TypeFamilies        #-}

-- module BettingContract where

-- import           Plutus.V2.Ledger.Api      (BuiltinData, Validator, mkValidatorScript, PubKeyHash)
-- import           Plutus.V2.Ledger.Contexts (ScriptContext, TxInfo, txInfoSignatories)
-- import           PlutusTx                  (compile, liftCode, applyCode)
-- import           PlutusTx.Prelude          hiding (Semigroup(..), unless)
-- import           Prelude                   (Show, String)

-- -- Define the betting parameters
-- data BetParams = BetParams
--   { bettor1   :: PubKeyHash  -- Public key hash of bettor 1
--   , bettor2   :: PubKeyHash  -- Public key hash of bettor 2
--   , condition :: BuiltinByteString -- The bet condition to validate
--   }
--   deriving Show

-- -- PlutusTx.unstableMakeIsData ''BetParams

-- -- Validate the bet outcome
-- {-# INLINABLE validateBet #-}
-- validateBet :: BetParams -> BuiltinByteString -> ScriptContext -> Bool
-- validateBet params outcome ctx =
--   let
--     info :: TxInfo
--     info = scriptContextTxInfo ctx

--     -- Check if the outcome matches the condition
--     outcomeMatches :: Bool
--     outcomeMatches = outcome == condition params

--     -- Verify if either bettor signed the transaction
--     signedByBettor1 :: Bool
--     signedByBettor1 = bettor1 params `elem` txInfoSignatories info

--     signedByBettor2 :: Bool
--     signedByBettor2 = bettor2 params `elem` txInfoSignatories info

--   in
--     outcomeMatches && (signedByBettor1 || signedByBettor2)

-- -- Compile the validator
-- {-# INLINABLE mkBettingValidator #-}
-- mkBettingValidator :: BetParams -> BuiltinByteString -> ScriptContext -> Bool
-- mkBettingValidator = validateBet

-- -- Boilerplate code to compile the validator
-- validator :: Validator
-- validator = mkValidatorScript $$(PlutusTx.compile [|| wrap ||])
--   where
--     wrap = mkBettingValidator


{-# LANGUAGE DataKinds           #-}
{-# LANGUAGE NoImplicitPrelude   #-}
{-# LANGUAGE TemplateHaskell     #-}
{-# LANGUAGE ScopedTypeVariables #-}
{-# LANGUAGE OverloadedStrings   #-}
{-# LANGUAGE DeriveAnyClass      #-}
{-# LANGUAGE DeriveGeneric       #-}
{-# LANGUAGE MultiParamTypeClasses #-}
{-# LANGUAGE TypeFamilies        #-}
{-# LANGUAGE TypeApplications #-}

module BettingContract where

import           Plutus.V2.Ledger.Api      (BuiltinData, Validator, mkValidatorScript, PubKeyHash, unsafeFromBuiltinData)
import           Plutus.V2.Ledger.Contexts (ScriptContext, TxInfo, txInfoSignatories, scriptContextTxInfo)
import           PlutusTx                  (compile, unstableMakeIsData)
import           PlutusTx.Prelude          hiding (Semigroup(..), unless)
import           Prelude                   (Show, String, IO, FilePath, writeFile, print, putStrLn)
import qualified Data.ByteString.Lazy as LBS
import qualified Data.ByteString.Short as SBS
import           Cardano.Api.Shelley (PlutusScript (..), writeFileTextEnvelope, displayError, PlutusScriptV2)
import qualified Plutus.V2.Ledger.Api
import           System.Directory (createDirectoryIfMissing)
import           System.FilePath (takeDirectory)
import           Cardano.Api
import           Codec.Serialise (serialise)

-- Define the betting parameters
data BetParams = BetParams
  { bettor1   :: PubKeyHash  -- Public key hash of bettor 1
  , bettor2   :: PubKeyHash  -- Public key hash of bettor 2
  , condition :: BuiltinByteString -- The bet condition to validate
  }
  deriving Show

-- Derive the necessary instances
PlutusTx.unstableMakeIsData ''BetParams

-- Validate the bet outcome
{-# INLINABLE validateBet #-}
validateBet :: BetParams -> BuiltinByteString -> ScriptContext -> Bool
validateBet params outcome ctx =
  let
    info :: TxInfo
    info = scriptContextTxInfo ctx

    -- Check if the outcome matches the condition
    outcomeMatches :: Bool
    outcomeMatches = outcome == condition params

    -- Verify if either bettor signed the transaction
    signedByBettor1 :: Bool
    signedByBettor1 = bettor1 params `elem` txInfoSignatories info

    signedByBettor2 :: Bool
    signedByBettor2 = bettor2 params `elem` txInfoSignatories info

  in
    outcomeMatches && (signedByBettor1 || signedByBettor2)

-- Compile the validator
{-# INLINABLE mkBettingValidator #-}
mkBettingValidator :: BetParams -> BuiltinByteString -> ScriptContext -> Bool
mkBettingValidator = validateBet

-- Define the wrap function correctly59102659102301000033232323322323322323232323232323232323233223232323232323232323232222232323253353232323500a225335333573466e20c8cccd54c03848004c8cd404888ccd404c00c004008d4040004cd4044888c00cc008004800488cdc0000a40040029000199aa98088900091299a991a800911111111111299a999aa980e0900099a80f91299a801108018800a81b9299a999ab9a3371e02000206c06a26a0720022a0700084206c20686a00a44004266a0340040022002a03200400204a04c204c266ae712401156e6f7420656e6f756768207369676e6174757265730002553353333333574800c46666ae68cdc39aab9d5006480008cccd55cfa8031281411999aab9f500625029233335573e6ae89401c94cd4c8c8c8c8c8c8c8c8c8c8c8c8c8c8ccccccd5d200711999ab9a3370e6aae7540392000233335573ea01c4a07646666aae7d4038940f08cccd55cfa8071281e91999aab9f500e2503e233335573ea01c4a07e46666aae7d4038941008cccd55cfa8071282091999aab9f500e25042233335573ea01c4a08646666aae7d4038941108cccd55cfa8071282291999aab9f500e25046233335573e6ae89403c94cd4cd40c40c8d5d0a80d90a99a99a8190199aba1501b21533533503303535742a03642a66a666aa070088a06e6ae85406c854cd4ccd540e411540e0d5d0a80d90a99a99a81b0211aba1501b2153353335503b04404535742a03642a66a646464646666666ae900108cccd5cd19b8735573aa008900011999aab9f500425055233335573ea0084a0ac46666aae7cd5d128029299a991919191999999aba400423333573466e1cd55cea8022400046666aae7d4010941788cccd55cfa8021282f91999aab9f35744a00a4a66a66a0b60b06ae85401c854cd4c174d5d0a803909a83189198008018010a8308a8301283003083002f9282e82f9282e1282e1282e1282e02e89aba25001135573ca00226ea8004d5d0a80390a99a991919191999999aba400423333573466e1cd55cea8022400046666aae7d40109417c8cccd55cfa8021283011999aab9f35744a00a4a66a66a0b80b26ae85401c854cd4c178d5d0a803909a83209198008018010a8310a830928308310308301282f0301282e9282e9282e9282e82f09aba25001135573ca00226ea8004d5d0a803909a82d09198008018010a82c0a82b9282b82c02b82b1282a02b1282992829928299282982a09aba25001135573ca00226ea8004d5d0a80d90a99a99a81c8249aba1501b2153353335503e043505135742a03642a66a666aa07e096a0a46ae85406c854cd4c11cd5d0a80d909a82a091999999999998008068060058050048040038030028020018010a8290a8288a8280a8278a8270a8268a8260a8258a8250a8248a8240a8239282382402382302282202182102082001f81f01e81e1281d01e1281c9281c9281c9281c81d09aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a01242a66a603c6ae85402484d40b448cc00400c008540ac540a8940a80ac0a80a49409c0a49409894098940989409809c840044c98c80a4cd5ce24810b77726f6e6720696e70757400027533530230062100113263202833573892010b77726f6e6720696e70757400026533530220062100113263202733573892010b77726f6e6720696e70757400025102513263202733573892010350543500025135744a00226aae7940044dd5000990009aa80f9108911299a80089a803001910999a8048029802001199aa980389000802802000891a80091000891a800910010910919800801801190009aa80d9108911299a800880111099802801199aa980389000802802000891911999999aba40012501a2501a2300337580044a0344a034036640026aa036446666aae7c0048d406d402c94cd4c010d5d080110a99a98021aba2003213501d33500c0020011501b1501a01b23232323333333574800846666ae68cdc39aab9d5004480008cccd55cfa8021280e11999aab9f50042501d233335573e6ae89401494cd4c048d5d0a80390a99a98059aba15007213502112330010030021501f1501e2501e01f01e01d2501b01d2501a2501a2501a2501a01b135744a00226aae7940044dd5000919191919191999999aba400623333573466e1cd55cea8032400046666aae7d4018940748cccd55cfa8031280f11999aab9f50062501f233335573ea00c4a04046666aae7cd5d128039299a991919191999999aba400423333573466e1cd55cea8022400046666aae7d4010940a08cccd55cfa8021281491999aab9f35744a00a4a66a60466ae85401c854cd4cd4074088d5d0a803909a81689198008018010a8158a81512815015815014928138149281312813128131281301389aba25001135573ca00226ea8004d5d0a80590a99a999aa80800e28079aba1500b215335323232323333333574800846666ae68cdc3a8012400846666aae7d4010940a88cccd55cf9aba2500523502c321222300200435742a00c4a05605805646666ae68cdc3a801a400446666aae7d4014940ac8cccd55cf9aba2500625335302635742a00e426a05c244460020082a0584a05805a05846666ae68cdc3a8022400046666aae7d40188d40b4488800c940b00b4940ac0b40b00ac940a0940a0940a0940a00a44d55cea80109aab9e5001137540026ae85402c854cd4cd4058078d5d0a805909a8130919998008028020018010a8120a8118a8110a8109281081101081000f80f1280e00f1280d9280d9280d9280d80e09aba25001135744a00226ae8940044d55cf280089baa0011335500100d00b112232233333335748002aa00a4a66a60066eac00884d40640045405d540155401554014060c8004d5406088c8cccd55cf80111a80ca8049299a98031aab9d5002215335300635573ca00642a66a600c6ae8801484d4070cd402c48cc00401000c0045406854064540600644d5d080088928090891001091091198008020018911919191999999aba400423333573466e1d40092000233335573ea0084a02c46666aae7cd5d128029299a98049aba15006213501935019001150172501701801723333573466e1d400d2002233335573ea00a46a030a02e4a02e0304a02c03002e4a0284a0284a0284a02802a26aae7540084d55cf280089baa00123232323333333574800846666ae68cdc3a8012400c46666aae7d4010940508cccd55cf9aba2500525335300b35742a00c426a02e24444600800a2a02a4a02a02c02a46666ae68cdc3a801a400846666aae7d4014940548cccd55cf9aba2500625335300d35742a00e426a03024444600400a2a02c4a02c02e02c46666ae68cdc3a8022400446666aae7d4018940588cccd55cf9aba2500725335300b35742a010426a03224444600200a2a02e4a02e03002e46666ae68cdc3a802a400046666aae7d401c9405c8cccd55cf9aba2500825335301235742a012426a03424444600600a2a0304a0300320304a02c03002e02c02a4a0244a0244a0244a02402626aae7540084d55cf280089baa00123232323333333574800846666ae68cdc39aab9d5004480008cccd55cfa8021280991999aab9f500425014233335573e6ae89401494cd4c028d5d0a80390a99a98071aba15007213501812330010030021501615015250150160150142501201425011250112501125011012135744a00226aae7940044dd5000919191999999aba400323333573466e1cd55cea801a400046666aae7d400c940448cccd55cf9aba2500425335300c35742a00a426a0280022a0244a0240260244a0200244a01e4a01e4a01e4a01e02026aae7940044dd500091919191919191999999aba400723333573466e1d4009200c233335573ea00e46a02a244444440064a02802a46666ae68cdc3a801a401446666aae7d40208d405848888888010940540588cccd5cd19b875004480208cccd55cfa8049280b11999aab9f500725017233335573e6ae89402094cd4c048d5d0a80610a99a98089aba1500a213501b122222223300100900815019150182501801901801723333573466e1d40152006233335573ea0144a02e46666aae7d4024940608cccd55cf9aba2500a25335301335742a01a42a66a60286ae85403084d407048888888cc0080240205406854064940640680640608cccd5cd19b875006480108cccd55cfa8059280c11999aab9f500b25019233335573e6ae89403094cd4c044d5d0a80710a99a980a9aba1500e213501d12222222330060090081501b1501a2501a01b01a01923333573466e1d401d2002233335573ea0184a03246666aae7cd5d128069299a98089aba1500e213501c1222222230070081501a2501a01b01a23333573466e1d40212000233335573ea01a4a03446666aae7cd5d128071299a98091aba1500f213501d1222222230050081501b2501b01c01b2501901b01a01901801701601525012250122501225012013135573aa00a26ae89400c4d5d1280109aba25001135573ca00226ea80048c8c8c8c8c8ccccccd5d200311999ab9a3370ea004900111999aab9f500625012233335573ea00c4a02646666aae7d4018940508cccd55cf9aba2500725335300d35742a01442a66a601c6ae854028854cd4c03cd5d0a805109a80c8911998008028020018a80b8a80b0a80a9280a80b00a80a00991999ab9a3370ea006900011999aab9f500725013233335573e6ae89402094cd4c034d5d0a804909a80b09118010018a80a1280a00a80a1280900a0099280812808128081280800889aab9d5004135744a00226ae8940044d55cf280089baa0012333333357480024a0144a0144a01446a0166eb40089402802c8c8c8c8ccccccd5d200211999ab9a3370ea004900111999aab9f50042500e233335573e6ae89401494cd4c024d5d0a803109a80889118008018a8079280780800791999ab9a3370ea006900011999aab9f50052500f233335573e6ae89401894cd4c028d5d0a803909a80909118010018a80812808008808128070080079280612806128061280600689aab9d5002135573ca00226ea80048ccccccd5d20009280412804128041280411a8049bae0020091223232323333333574800846666ae68cdc3a8012400846666aae7d40108d40384888004940340388cccd5cd19b875003480088cccd55cfa8029280711999aab9f35744a00c4a66a60146ae85401c84d40444888c00c0105403c9403c04003c8cccd5cd19b875004480008cccd55cfa80311a808091100112807808128070080078071280592805928059280580609aab9d5002135573ca00226ea80048c8c8c8ccccccd5d200211999ab9a3370ea004900111999aab9f500423500c0092500b00c23333573466e1d400d2000233335573ea00a46a01a0124a01801a4a01601a0184a0124a0124a0124a01201426aae7540084d55cf280089baa0011220021220012323333333574800446666ae68cdc39aab9d5002480008cccd55cf9aab9e5003235007008250060072500500725004250042500425004005137540022424460040062244002240029308919180080091198019801001000999a891119a8911980119a80224411ca8bc76574af70dd8784a78b753a342b2a57bd302578f6fb827aacaed005005480088848cc00400c00880044488008488488cc00401000c480041
{-# INLINABLE wrap #-}
wrap :: BuiltinData -> BuiltinData -> BuiltinData -> ()
wrap dat1 dat2 dat3 = 
  let
    params = unsafeFromBuiltinData dat1
    outcome = unsafeFromBuiltinData dat2
    ctx = unsafeFromBuiltinData dat3
  in
    if mkBettingValidator params outcome ctx then () else error ()

-- Boilerplate code to compile the validator
validator :: Validator
validator = mkValidatorScript $$(PlutusTx.compile [|| wrap ||])

writePlutusScript :: FilePath -> Validator -> IO ()
writePlutusScript file validator = do 
    createDirectoryIfMissing True (takeDirectory file)
    result <- writeFileTextEnvelope @(PlutusScript PlutusScriptV2) file Nothing $
        PlutusScriptSerialised . SBS.toShort . LBS.toStrict . serialise $ Plutus.V2.Ledger.Api.unValidatorScript 
        validator
    case result of 
        Left err -> print $ displayError err 
        Right () -> putStrLn "Successfully wrote Plutus script to file."

writeScript :: IO ()
writeScript = writePlutusScript "scripts5/bettingContract.plutus" validator
